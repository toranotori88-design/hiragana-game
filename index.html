<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¹³å‡åæ‰“å­—æ¸¸æˆ</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 14px; padding-top: 86px; }

    /* ALWAYS visible top bar */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0;
      background: #fff; border-bottom: 1px solid #eee;
      padding: 10px 14px; z-index: 9999;
    }
    .topinner { max-width: 560px; margin: 0 auto; display:flex; justify-content:space-between; gap:10px; }
    .title { font-weight: 900; }
    .stats { text-align:right; font-weight: 900; line-height: 1.2; }
    .stats small { font-weight: 700; opacity: .7; }

    /* Last result shown in top bar */
    .last {
      margin-top: 6px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      display: inline-block;
      border: 1px solid #eee;
    }
    .good { color:#0a7b2f; }
    .bad  { color:#b00020; }

    .panel { border: 1px solid #eee; border-radius: 16px; padding: 14px; margin-top: 10px; }
    .kana { font-size: 96px; text-align:center; margin: 16px 0 8px; }
    .hint { text-align:center; opacity:.75; margin-bottom: 10px; }
    .row  { display:flex; gap:10px; }
    input {
      flex:1; font-size: 22px; padding: 14px; border-radius: 14px;
      border: 1px solid #ccc;
    }
    button {
      font-size: 16px; padding: 12px 14px; border-radius: 14px;
      border: 1px solid #ccc; background: #f6f6f6; font-weight: 800;
    }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button.danger  { background:#b00020; color:#fff; border-color:#b00020; }
    button.small   { padding: 10px 12px; font-size: 14px; }
    .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top: 10px; }

    .groupBox { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top: 10px; }
    .chip {
      padding: 10px 12px; border-radius: 999px; border: 1px solid #ddd; background: #fff;
      font-weight: 900; cursor:pointer; user-select:none;
    }
    .chip.on { background:#111; color:#fff; border-color:#111; }
    .tiny { opacity:.7; font-size: 13px; text-align:center; margin-top: 8px; }

    .history {
      max-height: 240px; overflow:auto;
      border-top: 1px dashed #eee; margin-top: 12px; padding-top: 10px;
      font-size: 14px;
    }
    .hrow {
      display:flex; justify-content:space-between; gap:10px;
      padding: 8px 0; border-bottom: 1px solid #f2f2f2;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topinner">
      <div>
        <div class="title">å¹³å‡åæ‰“å­—æ¸¸æˆ</div>
        <div class="last" id="lastResult">å‡†å¤‡å°±ç»ª</div>
      </div>
      <div class="stats">
        åˆ†æ•°ï¼š<span id="score">0</span> Â· æœ€é«˜ï¼š<span id="best">0</span><br/>
        <small>å‰©ä½™ï¼š<span id="timeLeft">--</span>s</small>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="panel">
      <div class="kana" id="kana">ã‹</div>
      <div class="hint">è¾“å…¥ç½—é©¬éŸ³ï¼ˆä¾‹ï¼š<b>ka</b>ï¼‰ï¼ŒæŒ‰å›è½¦</div>

      <div class="row">
        <input id="ans" placeholder="åœ¨è¿™é‡Œè¾“å…¥ï¼ˆka, sa, shi...ï¼‰"
               autocapitalize="none" enterkeyhint="go"autocomplete="off" autocorrect="off" spellcheck="false"
               inputmode="latin" />
        <button id="okBtn" class="primary">ç¡®å®š</button>
      </div>

      <div class="controls">
        <button class="small" id="btn30">â± 30ç§’</button>
        <button class="small" id="btn60">â± 60ç§’</button>
        <button class="small primary" id="startBtn">å¼€å§‹</button>
        <button class="small danger" id="stopBtn" disabled>ç»“æŸ</button>
      </div>

      <div class="tiny">æ”¯æŒï¼šshi/siã€chi/tiã€tsu/tuã€fu/huã€ji/zi ç­‰å¸¸è§å†™æ³•ã€‚</div>

      <div class="history">
        <div style="font-weight:900; margin-bottom:6px;">è¾“å…¥è®°å½•ï¼ˆæœ€æ–°åœ¨ä¸Šé¢ï¼‰</div>
        <div id="historyList"></div>
        <div class="controls" style="margin-top:10px;">
          <button class="small" id="clearHistory">æ¸…ç©ºè®°å½•</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div style="text-align:center; font-weight:900;">é€‰æ‹©ç»ƒä¹ èŒƒå›´ï¼ˆåªé€‰ä¼šçš„ä¹Ÿå¯ä»¥ï¼‰</div>
      <div class="groupBox" id="groupBox"></div>

      <div class="controls" style="margin-top:12px;">
        <button class="small" id="selectAll">å…¨é€‰</button>
        <button class="small" id="selectNone">å…¨ä¸é€‰</button>
        <button class="small" id="resetMistakes">æ¸…ç©ºé”™é¢˜æƒé‡</button>
      </div>

      <div class="tiny">é”™å¾—è¶Šå¤šçš„å‡åä¼šæ›´å¸¸å‡ºç°ï¼ˆè‡ªåŠ¨é‡å¤ç›´åˆ°è®°ä½ï¼‰ã€‚</div>
    </div>

  </div>

<script>
/* ---------------- Data ---------------- */
const GROUPS = [
  { id:"A",  name:"ã‚è¡Œ (a i u e o)" },
  { id:"K",  name:"ã‹è¡Œ (ka...)" },
  { id:"S",  name:"ã•è¡Œ (sa...)" },
  { id:"T",  name:"ãŸè¡Œ (ta...)" },
  { id:"N",  name:"ãªè¡Œ (na...)" },
  { id:"H",  name:"ã¯è¡Œ (ha...)" },
  { id:"M",  name:"ã¾è¡Œ (ma...)" },
  { id:"Y",  name:"ã‚„è¡Œ (ya...)" },
  { id:"R",  name:"ã‚‰è¡Œ (ra...)" },
  { id:"W",  name:"ã‚è¡Œ (wa/wo/n)" },
  { id:"GZDBP", name:"æµŠéŸ³/åŠæµŠéŸ³ (ga/za/da/ba/pa)" },
];

const KANA = [
  {kana:"ã‚", a:["a"], g:"A"}, {kana:"ã„", a:["i"], g:"A"}, {kana:"ã†", a:["u"], g:"A"}, {kana:"ãˆ", a:["e"], g:"A"}, {kana:"ãŠ", a:["o"], g:"A"},
  {kana:"ã‹", a:["ka"], g:"K"}, {kana:"ã", a:["ki"], g:"K"}, {kana:"ã", a:["ku"], g:"K"}, {kana:"ã‘", a:["ke"], g:"K"}, {kana:"ã“", a:["ko"], g:"K"},
  {kana:"ã•", a:["sa"], g:"S"}, {kana:"ã—", a:["shi","si"], g:"S"}, {kana:"ã™", a:["su"], g:"S"}, {kana:"ã›", a:["se"], g:"S"}, {kana:"ã", a:["so"], g:"S"},
  {kana:"ãŸ", a:["ta"], g:"T"}, {kana:"ã¡", a:["chi","ti"], g:"T"}, {kana:"ã¤", a:["tsu","tu"], g:"T"}, {kana:"ã¦", a:["te"], g:"T"}, {kana:"ã¨", a:["to"], g:"T"},
  {kana:"ãª", a:["na"], g:"N"}, {kana:"ã«", a:["ni"], g:"N"}, {kana:"ã¬", a:["nu"], g:"N"}, {kana:"ã­", a:["ne"], g:"N"}, {kana:"ã®", a:["no"], g:"N"},
  {kana:"ã¯", a:["ha"], g:"H"}, {kana:"ã²", a:["hi"], g:"H"}, {kana:"ãµ", a:["fu","hu"], g:"H"}, {kana:"ã¸", a:["he"], g:"H"}, {kana:"ã»", a:["ho"], g:"H"},
  {kana:"ã¾", a:["ma"], g:"M"}, {kana:"ã¿", a:["mi"], g:"M"}, {kana:"ã‚€", a:["mu"], g:"M"}, {kana:"ã‚", a:["me"], g:"M"}, {kana:"ã‚‚", a:["mo"], g:"M"},
  {kana:"ã‚„", a:["ya"], g:"Y"}, {kana:"ã‚†", a:["yu"], g:"Y"}, {kana:"ã‚ˆ", a:["yo"], g:"Y"},
  {kana:"ã‚‰", a:["ra"], g:"R"}, {kana:"ã‚Š", a:["ri"], g:"R"}, {kana:"ã‚‹", a:["ru"], g:"R"}, {kana:"ã‚Œ", a:["re"], g:"R"}, {kana:"ã‚", a:["ro"], g:"R"},
  {kana:"ã‚", a:["wa"], g:"W"}, {kana:"ã‚’", a:["wo","o"], g:"W"}, {kana:"ã‚“", a:["n","nn"], g:"W"},

  {kana:"ãŒ", a:["ga"], g:"GZDBP"}, {kana:"ã", a:["gi"], g:"GZDBP"}, {kana:"ã", a:["gu"], g:"GZDBP"}, {kana:"ã’", a:["ge"], g:"GZDBP"}, {kana:"ã”", a:["go"], g:"GZDBP"},
  {kana:"ã–", a:["za"], g:"GZDBP"}, {kana:"ã˜", a:["ji","zi"], g:"GZDBP"}, {kana:"ãš", a:["zu"], g:"GZDBP"}, {kana:"ãœ", a:["ze"], g:"GZDBP"}, {kana:"ã", a:["zo"], g:"GZDBP"},
  {kana:"ã ", a:["da"], g:"GZDBP"}, {kana:"ã¢", a:["ji","di"], g:"GZDBP"}, {kana:"ã¥", a:["zu","du"], g:"GZDBP"}, {kana:"ã§", a:["de"], g:"GZDBP"}, {kana:"ã©", a:["do"], g:"GZDBP"},
  {kana:"ã°", a:["ba"], g:"GZDBP"}, {kana:"ã³", a:["bi"], g:"GZDBP"}, {kana:"ã¶", a:["bu"], g:"GZDBP"}, {kana:"ã¹", a:["be"], g:"GZDBP"}, {kana:"ã¼", a:["bo"], g:"GZDBP"},
  {kana:"ã±", a:["pa"], g:"GZDBP"}, {kana:"ã´", a:["pi"], g:"GZDBP"}, {kana:"ã·", a:["pu"], g:"GZDBP"}, {kana:"ãº", a:["pe"], g:"GZDBP"}, {kana:"ã½", a:["po"], g:"GZDBP"},
];

/* ---------------- LocalStorage keys ---------------- */
const LS_MIST = "kana_mistakes_v2";
const LS_BEST = "kana_best_v2";
const LS_HIST = "kana_history_v2";

/* ---------------- State ---------------- */
let enabledGroups = new Set(GROUPS.map(g => g.id));
let mistakes = loadJSON(LS_MIST, {});
let best = Number(localStorage.getItem(LS_BEST) || "0");
let history = loadJSON(LS_HIST, []); // newest first

let duration = 30;
let running = false;
let timer = null;
let timeLeft = 0;
let score = 0;
let current = null;

/* ---------------- DOM ---------------- */
const scoreEl = document.getElementById("score");
const bestEl  = document.getElementById("best");
const timeLeftEl = document.getElementById("timeLeft");
const lastResultEl = document.getElementById("lastResult");

const kanaEl = document.getElementById("kana");
const ansEl  = document.getElementById("ans");
const okBtn  = document.getElementById("okBtn");

const btn30 = document.getElementById("btn30");
const btn60 = document.getElementById("btn60");
const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");

const groupBox = document.getElementById("groupBox");
const historyList = document.getElementById("historyList");
const clearHistoryBtn = document.getElementById("clearHistory");

/* ---------------- Helpers ---------------- */
function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
  catch { return fallback; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

function normalize(s){ return (s||"").trim().toLowerCase().replace(/\s+/g,""); }

function getActivePool(){
  return KANA.filter(x => enabledGroups.has(x.g));
}

function weightedPick(pool){
  // wrong -> more likely
  let total = 0;
  const weights = pool.map(item=>{
    const w = 1 + (mistakes[item.kana] || 0) * 2;
    total += w;
    return w;
  });
  let r = Math.random() * total;
  for (let i=0;i<pool.length;i++){
    r -= weights[i];
    if (r <= 0) return pool[i];
  }
  return pool[pool.length-1];
}

function setLast(text, kind){
  lastResultEl.textContent = text;
  lastResultEl.classList.remove("good","bad");
  if (kind) lastResultEl.classList.add(kind);
}

function renderHistory(){
  historyList.innerHTML = "";
  history.slice(0, 50).forEach(h=>{
    const row = document.createElement("div");
    row.className = "hrow";
    row.innerHTML = `
      <div><b>${h.kana}</b> <span class="mono" style="opacity:.7;">(${h.correct})</span></div>
      <div class="mono">${h.typed || "(ç©º)"}</div>
      <div class="${h.ok ? "good" : "bad"}">${h.ok ? "âœ…" : "âŒ"}</div>
    `;
    historyList.appendChild(row);
  });
}

/* ---------------- Groups UI ---------------- */
function renderGroups(){
  groupBox.innerHTML = "";
  GROUPS.forEach(g=>{
    const chip = document.createElement("div");
    chip.className = "chip" + (enabledGroups.has(g.id) ? " on" : "");
    chip.textContent = g.name;
    chip.onclick = ()=>{
      if (running) return;
      if (enabledGroups.has(g.id)) enabledGroups.delete(g.id);
      else enabledGroups.add(g.id);
      renderGroups();
      if (!running) pickNext();
    };
    groupBox.appendChild(chip);
  });
}

/* ---------------- Game ---------------- */
function pickNext(){
  const pool = getActivePool();
  if (pool.length === 0){
    kanaEl.textContent = "ï¼Ÿ";
    setLast("è¯·å…ˆåœ¨ä¸‹é¢é€‰æ‹©ç»ƒä¹ èŒƒå›´", "bad");
    return;
  }
  current = weightedPick(pool);
  kanaEl.textContent = current.kana;
  ansEl.value = "";
  ansEl.focus({ preventScroll: true });
}

function submit(){
  if (!running || !current) return;
  const typed = normalize(ansEl.value);
  if (!typed) return;

  const ok = current.a.includes(typed);
  const correct = current.a[0];

  if (ok){
    score += 10;
    setLast(`âœ… æ­£ç¡®ï¼ ${current.kana} = ${correct}`, "good");
    // forgive slowly
    if (mistakes[current.kana] > 0) {
      mistakes[current.kana] = Math.max(0, mistakes[current.kana] - 1);
      saveJSON(LS_MIST, mistakes);
    }
  } else {
    score = Math.max(0, score - 5);
    mistakes[current.kana] = (mistakes[current.kana] || 0) + 1;
    saveJSON(LS_MIST, mistakes);
    setLast(`âŒ é”™äº†ï¼šä½ è¾“å…¥ ${typed}ï¼Œæ­£ç¡®æ˜¯ ${correct}`, "bad");
  }

  // record what they typed
  history.unshift({
    t: Date.now(),
    kana: current.kana,
    typed,
    correct,
    ok
  });
  history = history.slice(0, 100);
  saveJSON(LS_HIST, history);
  renderHistory();

  scoreEl.textContent = score;
  if (score > best){
    best = score;
    bestEl.textContent = best;
    localStorage.setItem(LS_BEST, String(best));
  }
  ansEl.focus({ preventScroll: true });
  setTimeout(pickNext, 250);
}

function setDuration(sec){
  if (running) return;
  duration = sec;
  btn30.classList.toggle("primary", sec===30);
  btn60.classList.toggle("primary", sec===60);
}
btn30.onclick = ()=>setDuration(30);
btn60.onclick = ()=>setDuration(60);

function start(){
  const pool = getActivePool();
  if (pool.length === 0){
    setLast("å…ˆåœ¨ä¸‹é¢é€‰æ‹©ä½ æƒ³ç»ƒçš„è¡Œï¼ˆä¾‹å¦‚ ã‚è¡Œ / ã‹è¡Œï¼‰", "bad");
    return;
  }

  running = true;
  score = 0;
  scoreEl.textContent = score;

  timeLeft = duration;
  timeLeftEl.textContent = timeLeft;

  startBtn.disabled = true;
  stopBtn.disabled = false;

  setLast("å¼€å§‹ï¼å†²åˆ†ï¼ğŸ”¥", null);
  pickNext();

  timer = setInterval(()=>{
    timeLeft--;
    timeLeftEl.textContent = timeLeft;
    if (timeLeft <= 0) stop();
  }, 1000);
}

function stop(){
  if (!running) return;
  running = false;
  clearInterval(timer);
  timer = null;

  startBtn.disabled = false;
  stopBtn.disabled = true;
  timeLeftEl.textContent = "--";

  setLast(`æ—¶é—´åˆ°ï¼æœ¬å±€åˆ†æ•°ï¼š${score}`, null);
}

okBtn.onclick = submit;
ansEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();       // stops the browser from doing "Done" -> blur
    submit();
  }
});


startBtn.onclick = start;
stopBtn.onclick = stop;

/* ---------------- Bottom buttons ---------------- */
document.getElementById("selectAll").onclick = ()=>{
  if (running) return;
  enabledGroups = new Set(GROUPS.map(g=>g.id));
  renderGroups();
  pickNext();
};
document.getElementById("selectNone").onclick = ()=>{
  if (running) return;
  enabledGroups = new Set();
  renderGroups();
  pickNext();
};
document.getElementById("resetMistakes").onclick = ()=>{
  mistakes = {};
  localStorage.removeItem(LS_MIST);
  setLast("âœ… å·²æ¸…ç©ºé”™é¢˜æƒé‡ï¼ˆå‡ºç°æ¦‚ç‡é‡ç½®ï¼‰", "good");
};

clearHistoryBtn.onclick = ()=>{
  history = [];
  localStorage.removeItem(LS_HIST);
  renderHistory();
  setLast("âœ… å·²æ¸…ç©ºè¾“å…¥è®°å½•", "good");
};

/* ---------------- Init ---------------- */
bestEl.textContent = best;
setDuration(30);
renderGroups();
renderHistory();
pickNext();
</script>
</body>
</html>
